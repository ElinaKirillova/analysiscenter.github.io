---
layout: post
title: Храните данные в feather-файлах
comments: true
tags: python, feather, pandas
---

Скорость анализа зависит не только от производительности и количества процессоров, но и от того, насколько быстро выполняется чтение и запись файлов с исходными данными и результатами.

К счастью, благодаря формату данных [feather](https://github.com/wesm/feather) можно загружать и сохранять данные со скоростью **800 Мбайт/с** даже на обычном ноутбуке.

Но это не единственное преимущество. Feather поддерживает не только простые типы данных (например, целые и вещественные числа), но и категориальные: [Categorical в pandas](http://pandas.pydata.org/pandas-docs/stable/categorical.html) и [factor в R](https://stat.ethz.ch/R-manual/R-devel/library/base/html/factor.html).

Кроме того, feather очень компактно хранит строки. Например, массив `['Иван', 'Петрович', 'Смирнов']` будет записан в виде `['ИванПетровичСмирнов', [0,4,12]]`. И это тоже помогает ускорить чтение и запись файлов.

А еще, и порой это самое главное, feather позволяет сохранять `NA`-значения для любых типов, а не только для float и datetime.

Более подробно про формат вы можете прочитать [в документации](https://github.com/wesm/feather/blob/master/doc/FORMAT.md) и в спецификации [Apache Arrow](https://arrow.apache.org/), на которой он и основан.

В общем, feather спроектирован так, чтобы поддерживать векторные операции и SIMD инструкции современных процессоров. Именно поэтому он такой быстрый.


## О создателях
В работе над feather уже приняли участие более 20 разработчиков. Но начало всему положили два совершенно легендарных человека: [Wes McKinney](http://wesmckinney.com/) (создатель пакета [pandas](http://pandas.pydata.org/)) и [Hadley Wickham](http://hadley.nz/) (создатель [ggplot2](http://ggplot2.org/), [dplyr](https://github.com/hadley/dplyr) и других известных пакетов для R). Так что feather заслуживает внимания.


## Установить пакет
Python'овский пакет для работы с feather-файлами называется `feather-format`. Устанавливается он самым обычным способом:
```terminal
pip install feather-format
```

Если вы используете [Anaconda](https://www.continuum.io/anaconda-overview), то пакет `feather-format` можно найти в [conda-forge](https://conda-forge.github.io/):
```terminal
conda install -c conda-forge feather-format
```
Однако под Windows установка будет успешной, только если у вас python 3.5. Для [python 2.7 удобного рецепта нет](https://github.com/wesm/feather/issues/151) и, судя по всему, не будет.


## Записать датафрейм

```python
import feather
#... 

# создаем датафрейм с визитами в городские поликлиники (загружаем из СУБД)
df_visits = load_visits(from="01.01.2016", to="30.06.2016", clinics="poly")

# и теперь сохраняем его в feather-файл
feather.write_dataframe(df_visits, 'visits.feather')
```
При этом помните, что  `feather` все еще развивается и поэтому не подходит для долговременного хранения файлов, поскольку новые версии формата могут быть несовместимы со старыми.
{: .message}


## Прочитать датафрейм

Загрузка датафрейма из feather-файла также осуществляется одной командой:

```python
import feather
#... 

# загружаем датафрейм с визитами в поликлиники
df_visits = feather.read_dataframe('visits.feather', columns=['clinic_id', 'patient_id', 'date', 'duration'])
```
Одно из ключевых преимуществ формата feather заключается в возможности загружать не весь датафрейм, а лишь отдельные столбцы.

Для нас это очень важно, поскольку датафреймы порой содержат десятки и даже сотни столбцов, а во многих видах анализа мы используем лишь десять-двадцать из них. И тогда вместо загрузки 100 Гб данных на мощный и дорогой сервер мы можем ограничиться 8-15 ГБайтами и небольшой виртуальной машиной.


## А теперь в R
Очень удобно, что feather-файлы можно использовать не только в python, но и в R.

```r
library(feather)
path <- "visits.feather"

write_feather(df_visits, path)

df_visits <- read_feather(path)
```
Благодаря этому мы легко переносим данные между R и python'ом и строим статистические модели, задействуя широкий функционал R.


## Подводя итог
Итак, теперь вы знаете, что формат [feather](https://github.com/wesm/feather) весьма удобен для анализа данных.  
Во-первых, он очень быстр - скорость чтения/записи даже на обычном ноутбуке может превышать 800 Мбайт в секунду.

Во-вторых, он компактно хранит данные (благодаря поддержке `Categorical`/`factor` и строк переменной длины).

В-третьих, он умеет обращаться с `NA`-значениями для любых типов данных